# 翻譯 API 安全性改進

## 概述

為了防止惡意使用者濫用手動翻譯 API (`/api/translate/{article_url}`) 造成 OpenAI API 費用損失，我們實作了以下安全機制：

## 🔒 安全改進措施

### 1. 重複翻譯檢查
- **檢查翻譯狀態**：在執行翻譯前檢查文章是否已經完全翻譯
- **避免重複翻譯**：如果文章已有所有語言版本的翻譯，直接返回已翻譯狀態
- **部分翻譯更新**：只翻譯缺失的語言版本，避免重複翻譯已存在的內容

### 2. 時間間隔限制
- **冷卻時間**：同一文章在 1 小時內不能重複翻譯
- **資料庫層面檢查**：使用 SQLite 的 datetime 函數直接在資料庫層面過濾最近的翻譯記錄
- **翻譯日誌追蹤**：記錄所有翻譯請求以供監控和分析

### 3. IP 速率限制
- **每小時限制**：每個 IP 地址每小時最多 5 次翻譯請求
- **自動清理**：過期的請求記錄會自動清理
- **HTTP 429 回應**：超過限制時返回適當的 HTTP 狀態碼

### 4. 監控和管理功能
- **監控端點**：`/api/translation-monitoring` 提供詳細的使用統計
- **管理功能**：`/api/admin/reset-rate-limits` 允許重置速率限制（管理員功能）
- **翻譯日誌**：完整記錄所有翻譯活動以供審計

## 📊 API 端點說明

### 翻譯端點 (已改進)
```
POST /api/translate/{article_url}
```

**新的回應狀態：**
- `already_translated`: 文章已完全翻譯
- `rate_limited`: 觸發速率限制
- `no_updates_needed`: 沒有需要更新的翻譯
- `success`: 翻譯成功完成

### 監控端點 (新增)
```
GET /api/translation-monitoring
```

**回應內容：**
- 速率限制配置
- 活躍 IP 統計
- 最近翻譯統計
- 系統狀態資訊

### 管理端點 (新增)
```
POST /api/admin/reset-rate-limits
```

**功能：**
- 重置所有 IP 的速率限制記錄
- 返回清理的 IP 數量

## 🛡️ 安全配置

### 速率限制設定
```python
TRANSLATION_RATE_LIMIT = 5      # 每小時最多5次請求
RATE_LIMIT_WINDOW = 3600        # 1小時窗口（秒）
```

### 冷卻時間設定
```python
TRANSLATION_COOLDOWN = 1        # 1小時冷卻時間
```

## 🧪 測試

使用提供的測試腳本驗證安全機制：

```bash
python test_translation_security.py
```

**測試項目：**
1. 正常翻譯請求
2. 重複翻譯請求檢查
3. 速率限制測試
4. 監控端點功能

## 📈 預期效果

### 成本控制
- **防止重複翻譯**：避免對同一文章重複呼叫 OpenAI API
- **速率限制**：限制惡意使用者的請求頻率
- **時間間隔**：防止短時間內大量翻譯請求

### 系統穩定性
- **資源保護**：避免 API 配額被快速消耗
- **監控能力**：提供詳細的使用統計和異常檢測
- **管理工具**：提供必要的管理和維護功能

## 🔧 進一步改進建議

### 短期改進
1. **認證機制**：添加 API 金鑰或使用者認證
2. **更細緻的權限控制**：區分一般使用者和管理員權限
3. **警報系統**：異常使用模式的自動警報

### 長期改進
1. **分散式速率限制**：使用 Redis 等外部儲存
2. **機器學習檢測**：使用 ML 模型檢測異常行為
3. **成本追蹤**：詳細的 API 使用成本分析

## 📝 使用注意事項

1. **正常使用不受影響**：這些限制不會影響正常的翻譯需求
2. **監控建議**：定期檢查監控端點以了解系統使用情況
3. **日誌保留**：翻譯日誌會持續累積，建議定期清理舊記錄
4. **配置調整**：可根據實際使用情況調整速率限制參數

## 🚨 緊急情況處理

如果發現異常的 API 使用：

1. **立即重置速率限制**：
   ```bash
   curl -X POST http://localhost:8000/api/admin/reset-rate-limits
   ```

2. **檢查監控資訊**：
   ```bash
   curl http://localhost:8000/api/translation-monitoring
   ```

3. **查看翻譯日誌**：檢查資料庫中的 `translation_logs` 表

4. **調整限制參數**：如需要，可在程式碼中調整 `TRANSLATION_RATE_LIMIT` 等參數